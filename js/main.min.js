!function(e){var s=e.app||(e.app={}),t=Backbone.Model.extend({defaults:function(){return{name:"",code:"",instructor:"",classes:[]}},addClass:function(e){if(_.isObject(e)&&e.hasOwnProperty("day")&&e.hasOwnProperty("start")&&e.hasOwnProperty("end"))return this.attributes.classes.push(e),this.trigger("change"),this.save(),this.isValid()},removeClass:function(e){var s;if(_.isNumber(e)){if(e>=0&&e<this.attributes.classes.length)return this.attributes.classes.splice(e,1)}else if(_.isObject(e)&&(s=this.attributes.classes.indexOf(e))>-1)return this.attributes.classes.splice(s,1);this.save()},validate:function(e){function s(s){var t=!1;return e.classes.forEach(function(e){_.has(e,s)||(t=!0)}),t}function t(s){var t=new RegExp("^((10|11|12|[1-9]):[0-5][0-9][A|P][M])$"),i=!1;return e.classes.forEach(function(e){"start"==s?t.test(e.start)||(i=!0):"end"==s&&(t.test(e.end)||(i=!0))}),i}function i(e){var s,t=[];return e=e.split(":"),s=parseInt(e[0]),-1!=e[1].indexOf("AM")&&12!=s||-1!=e[1].indexOf("PM")&&12==s?(t.hrs=s,t.mins=parseInt(e[1])):-1!=e[1].indexOf("PM")&&12!=s?(t.hrs=s+12,t.mins=parseInt(e[1])):-1!=e[1].indexOf("AM")&&12==s&&(t.hrs=s-12,t.mins=parseInt(e[1])),t}var n=[],r=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"];return e.hasOwnProperty("name")&&_.isEmpty(e.name)&&n.push({name:"emptyName",message:"Course name cannot be empty."}),e.hasOwnProperty("code")&&_.isEmpty(e.code)&&n.push({name:"emptyCode",message:"Course code cannot be empty."}),e.hasOwnProperty("instructor")&&_.isEmpty(e.instructor)&&n.push({name:"emptyInstructor",message:"Instructor's name cannot be empty."}),e.hasOwnProperty("classes")&&s("day")&&n.push({name:"missingClassDay",message:"Class day is missing."}),e.hasOwnProperty("classes")&&function(){var s=!1;return e.classes.forEach(function(e){void 0!==e.day&&-1===_.indexOf(r,e.day.toLowerCase())&&(s=!0)}),s}()&&n.push({name:"invalidClassDay",message:"Class day cannot be empty or is invalid."}),e.hasOwnProperty("classes")&&s("start")&&n.push({name:"missingClassStart",message:"Class start time is missing."}),e.hasOwnProperty("classes")&&t("start")&&n.push({name:"invalidClassStart",message:"Class start time is invalid."}),e.hasOwnProperty("classes")&&s("end")&&n.push({name:"missingClassEnd",message:"Class end time is missing."}),e.hasOwnProperty("classes")&&t("end")&&n.push({name:"invalidClassEnd",message:"Class end time is invalid."}),!e.hasOwnProperty("classes")||t("start")||t("end")||function(){var s,t,n=!1;return e.classes.forEach(function(e){void 0!==e.start&&void 0!==e.end&&(s=i(e.start),t=i(e.end),s.hrs>t.hrs?n=!0:s.hrs==t.hrs&&s.mins>=t.mins&&(n=!0))}),n}()&&n.push({name:"classStartEndConflict",message:"Class end time cannot occur before start time."}),n.length>0&&n}});s.models||(s.models={}),s.models.Course=t,Schedule=e.Backbone.Collection.extend({model:s.models.Course,localStorage:new Backbone.LocalStorage("Schedule"),forDay:function(e){return this.filter(function(s){var t;return s.get("classes").forEach(function(s){s.day.toUpperCase()===e.toUpperCase()&&(t=!0)}),t})},forCode:function(e){return this.filter(function(s){var t;return s.get("code").toUpperCase()===e.toUpperCase()&&(t=!0),t})},forName:function(e){return this.filter(function(s){var t;return s.get("name").toUpperCase()===e.toUpperCase()&&(t=!0),t})},forInstructor:function(e){return this.filter(function(s){var t;return s.get("instructor").toUpperCase()===e.toUpperCase()&&(t=!0),t})}}),s.collections||(s.collections={}),s.collections.Schedule=Schedule,CourseView=Backbone.View.extend({tagName:"div",template:Handlebars.compile($("#course-view-template").html()),errorTemplate:Handlebars.compile($("#course-view-errors-template").html()),events:{"submit .course-form":"addUpdateCourse","click .btn.add-section":"addSection","click .btn.add-time":"addClassTime","click .btn.cancel-time":"resetTimeForm"},initialize:function(e){this.options=e||{},this.options.model||(this.model=new s.models.Course),this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.attributes)),this},renderErrors:function(){this.$el.find(".errors").html(this.errorTemplate({errors:this.model.validationError}))},addUpdateCourse:function(e){e.preventDefault(),this.model.set({code:this.$el.find("input#course-code").val(),name:this.$el.find("input#course-name").val(),instructor:this.$el.find("input#course-instructor").val()},{validate:!0}),this.model.isValid()?s.schedule.add(this.model):this.renderErrors()},addSection:function(){this.$el.find(".btn-add-course-time").addClass("hidden"),this.$el.find(".time-controls").removeClass("hidden")},addClassTime:function(){var e=this.$el.find("select#course-time-day").val(),s=this.$el.find("input#course-time-start").val(),t=this.$el.find("input#course-time-end").val();this.model.addClass({day:e,start:s,end:t})?(this.$el.find(".time-controls").addClass("hidden"),this.$el.find(".btn-add-course-time").removeClass("hidden"),this.render()):this.renderErrors()},resetTimeForm:function(){this.$el.find(".time-controls").addClass("hidden"),this.$el.find(".btn-add-course-time").removeClass("hidden")}}),s.views||(s.views={}),s.views.CourseView=CourseView,ScheduleView=Backbone.View.extend({tagName:"div",template:Handlebars.compile($("#schedule-view-template").html()),events:{"click .btn.delete-time":"removeClassTime"},initialize:function(e){this.options=e||{},this.options.collection||(this.collection=new s.collections.Schedule),this.listenTo(this.collection,"change",this.render),this.listenTo(this.collection,"add",this.render)},render:function(){return this.$el.html(this.template({courses:this.collection.models})),this},removeClassTime:function(e){var s=parseInt(e.target.dataset.parent),t=parseInt(e.target.dataset.index);"undefined"!=this.collection.models[s].removeClass(t)&&this.render()},modifyCourse:function(e){s.appView.renderCourseView(e,this.collection.get(e.currentTarget.dataset.id)),s.router.navigate("courses/"+e.currentTarget.dataset.id,{trigger:!0})}}),s.views||(s.views={}),s.views.ScheduleView=ScheduleView,AppView=Backbone.View.extend({el:"body",events:{"click a.add-course":"renderCourseView"},initialize:function(){this.scheduleView=new s.views.ScheduleView({collection:s.schedule}),this.$el.find(".schedule-display").html(this.scheduleView.render().el)},renderCourseView:function(e){this.courseView&&this.courseView.remove(),this.courseView=new s.views.CourseView,this.$el.find(".course-display").html(this.courseView.render().el),e.preventDefault()}}),s.views||(s.views={}),s.views.AppView=AppView,AppRouter=e.Backbone.Router.extend({routes:{index:"index","courses/:id":"renderCourse"},index:function(){s.schedule.fetch(),this.sync()},renderCourse:function(e){s.schedule.fetch(),s.AppView.renderCourseView({preventDefault:function(){return!1}},s.schedule.get(e))}}),s.routers||(s.routers={}),s.routers.AppRouter=AppRouter,s.schedule=new s.collections.Schedule,s.view=new s.views.AppView,s.router=new s.routers.AppRouter,Backbone.history.start()}(this);